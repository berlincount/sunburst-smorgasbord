
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Social share meta tags -->
  <!-- <meta property="og:title" content="Simple Grid">
  <meta property="og:description" content="A responsive, lightweight, simple CSS grid.">
  <meta property="og:type" content="website">
  <meta property="og:image" content="http://simplegrid.io/img/simple-grid-computer.png">
  <meta property="og:site_name" content="Simple Grid">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Simple Grid">
  <meta name="twitter:description" content="A responsive, lightweight, simple CSS grid.">
  <meta name="twitter:image:src" content="http://simplegrid.io/img/simple-grid-computer.png"> -->
  <!-- End social share meta tags -->
  <link rel="shortcut icon" href="img/favicon.png">
  <link rel="stylesheet" href="css/simple-grid.css">
  <title>Sunburst Smorgasbord | a tool to describe your relationships.</title>
  <meta name="description" content="A customizable smorgasbord to describe your relationships.">
  <script src="https://cdn.rawgit.com/eligrey/canvas-toBlob.js/f1a01896135ab378aa5c0118eadd81da55e698d8/canvas-toBlob.js"></script>
	<script src="https://cdn.rawgit.com/eligrey/FileSaver.js/e9d941381475b5df8b7d7691013401e171014e89/FileSaver.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="/js/sunburst.d3.js"></script>
    <script>

      const mainWidth = 1152;
      const mainHeight = 1152;

        d3.json("/assets/autoingredients.json")
        .then(function(flare) {
            let chart = Sunburst(flare, {
                //value: d => d.size, // size of each node (file); null for internal nodes (folders)
                label: d => d.id, // display name for each cell
                title: (d, n) => d.id, // hover text
                /*
                link: (d, n) => n.children
                  ? `https://github.com/prefuse/Flare/tree/master/flare/src/${n.ancestors().reverse().map(d => d.data.name).join("/")}`
                  : `https://github.com/prefuse/Flare/blob/master/flare/src/${n.ancestors().reverse().map(d => d.data.name).join("/")}.as`,
                */
                width: mainWidth,
                height: mainHeight
            });

            document.querySelector("#sunburstContainer")
                .appendChild(chart);

            
            //PNG EXPORT FUNCTIONALITY
            // Set-up the export button
            d3.select('#saveButton').on('click', function(){
              let svgString = getSVGString(document.getElementById('theImage'));
              
              svgString2Image( svgString, 2*mainWidth, 2*mainHeight, 'png', save ); // passes Blob and filesize String to the callback

              function save( dataBlob, filesize ){
                saveAs( dataBlob, 'D3 vis exported to PNG.png' ); // FileSaver.js function
              }
            });
        

            // Below are the functions that handle actual exporting:
            // getSVGString ( svgNode ) and svgString2Image( svgString, width, height, format, callback )
            function getSVGString( svgNode ) {
              svgNode.setAttribute('xlink', 'http://www.w3.org/1999/xlink');
              let cssStyleText = getCSSStyles( svgNode );
              appendCSS( cssStyleText, svgNode );

              let serializer = new XMLSerializer();
              let svgString = serializer.serializeToString(svgNode);
              svgString = svgString.replace(/(\w+)?:?xlink=/g, 'xmlns:xlink='); // Fix root xlink without namespace
              svgString = svgString.replace(/NS\d+:href/g, 'xlink:href'); // Safari NS namespace fix

              return svgString;

              function getCSSStyles( parentElement ) {
                let selectorTextArr = [];

                // Add Parent element Id and Classes to the list
                selectorTextArr.push( '#'+parentElement.id );
                for (let c = 0; c < parentElement.classList.length; c++)
                    if ( !contains('.'+parentElement.classList[c], selectorTextArr) )
                      selectorTextArr.push( '.'+parentElement.classList[c] );

                // Add Children element Ids and Classes to the list
                let nodes = parentElement.getElementsByTagName("*");
                for (let i = 0; i < nodes.length; i++) {
                  let id = nodes[i].id;
                  if ( !contains('#'+id, selectorTextArr) )
                    selectorTextArr.push( '#'+id );

                  let classes = nodes[i].classList;
                  for (let c = 0; c < classes.length; c++)
                    if ( !contains('.'+classes[c], selectorTextArr) )
                      selectorTextArr.push( '.'+classes[c] );
                }

                // Extract CSS Rules
                let extractedCSSText = "";
                for (let i = 0; i < document.styleSheets.length; i++) {
                  let s = document.styleSheets[i];
                  
                  try {
                      if(!s.cssRules) continue;
                  } catch( e ) {
                        if(e.name !== 'SecurityError') throw e; // for Firefox
                        continue;
                      }

                  var cssRules = s.cssRules;
                  for (let r = 0; r < cssRules.length; r++) {
                    if ( contains( cssRules[r].selectorText, selectorTextArr ) )
                      extractedCSSText += cssRules[r].cssText;
                  }
                }
                

                return extractedCSSText;

                function contains(str,arr) {
                  return arr.indexOf( str ) === -1 ? false : true;
                }

              }

              function appendCSS( cssText, element ) {
                let styleElement = document.createElement("style");
                styleElement.setAttribute("type","text/css"); 
                styleElement.innerHTML = cssText;
                let refNode = element.hasChildNodes() ? element.children[0] : null;
                element.insertBefore( styleElement, refNode );
              }
            }


            function svgString2Image( svgString, width, height, imageFormat, callback ) {
              const format = imageFormat ? imageFormat : 'png';

              let imgsrc = 'data:image/svg+xml;base64,'+ btoa( unescape( encodeURIComponent( svgString ) ) ); // Convert SVG string to data URL

              let canvas = document.createElement("canvas");
              let context = canvas.getContext("2d");

              canvas.width = width;
              canvas.height = height;

              let image = new Image();
              image.onload = function() {
                context.clearRect ( 0, 0, width, height );
                context.drawImage(image, 0, 0, width, height);

                canvas.toBlob( function(blob) {
                  let filesize = Math.round( blob.length/1024 ) + ' KB';
                  if ( callback ) callback( blob, filesize );
                });

                
              };

              image.src = imgsrc;
            }
});
    </script>
</head>
<body>
  <div class="jumbotron">
    <div class="container">
      <div class="row">
        <div class="col-12 center">
          <div class="img img-logo center"></div>
          <h1>Sunburst Smorgasbord.</h1>
          <h2 class="font-light">Relationship anarchy, as radiant as the sun.</h2>
        </div>
      </div>
    </div>
  </div>
  <div class="body-content">
    <div class="container-fluid">
      <div class="row">
        <div class="col-12 center" id="sunburstContainer">
          <div>
            <button id='saveButton'>Save a pic of your shining smorgasbord</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- <footer>
    <div class="container">
      <div class="row">
        <div class="col-12">
          <p>Sunburst Smorgasbord<br/>
          Made by JayK / Shandalara / dzing
        </div>
      </div>
    </div>
  </footer> -->
</body>
</html>
